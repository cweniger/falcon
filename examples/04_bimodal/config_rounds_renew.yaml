# Model-specific configuration using _target_ pattern
# PCA streaming example configuration

# Set model path to current directory (for local model.py)
model_path: "src"
# model_path: "${hydra:runtime.cwd}/examples/04_bimodal/src"

# WandB configuration
logging:
  project: falcon2_bimodal
  group: new_run_1
  dir: ${hydra:run.dir}

# Directory configuration (relative to Hydra output directory)
paths:
  buffer: ${hydra:run.dir}/sim_dir
  graph: ${hydra:run.dir}/graph_dir

# Training buffer parameters
buffer:
  min_training_samples: 8000
  max_training_samples: 8000
  validation_window_size: 256
  resample_batch_size: 8000
  keep_resampling: true
  resample_interval: 300

# Graph definition using declarative YAML
graph:
  z:
    evidence: [x]
    scaffolds: [m, n]
    simulator: 
      _target_: falcon.contrib.HypercubeMappingPrior
      priors: 
        - ['uniform', -10000.0, 10000.0]
        - ['uniform', -10000.0, 10000.0]
        - ['uniform', -10000.0, 10000.0]
        - ['uniform', -10000.0, 10000.0]
        - ['uniform', -10000.0, 10000.0]
        - ['uniform', -10000.0, 10000.0]
        - ['uniform', -10000.0, 10000.0]
        - ['uniform', -10000.0, 10000.0]
        - ['uniform', -10000.0, 10000.0]
        - ['uniform', -10000.0, 10000.0]
        #- ['uniform', -0.3, 0.3]
        #- ['uniform', -0.3, 0.3]
        #- ['uniform', -0.3, 0.3]
        #- ['uniform', -0.3, 0.3]
        #- ['uniform', -0.3, 0.3]
        #- ['uniform', -0.3, 0.3]
        #- ['uniform', -0.3, 0.3]
        #- ['uniform', -0.3, 0.3]
        #- ['uniform', -0.3, 0.3]
        #- ['uniform', -0.3, 0.3]
    estimator:
      _target_: falcon.contrib.SNPE_A
      embedding:
         _target_: model.E
         _input_: [x, m, n]
      discard_samples: false
      net_type: nsf #zuko_gf # maf, nice, sospf, naf, gf
      gamma: 0.5
      num_epochs: 300
      batch_size: 128
      lr: 0.01
      early_stop_patience: 32
      lr_decay_factor: 0.5
      scheduler_patience: 16
      sample_reference_posterior: false
      use_best_models_during_inference: true
      use_log_update: true
      theta_norm: true
      norm_momentum: 0.01
      #device: cuda
      log_ratio_threshold: -20
    ray:
      num_gpus: 1
  
  m:
    parents: [z]
    simulator: model.Signal

  n:
    simulator: model.Noise

  x:
    parents: [m, n]
    simulator: model.Add
    #observed: "${hydra:runtime.cwd}/examples/04_bimodal/data/x_obs_10dim.npy"
    observed: "data/x_obs_10dim_zeros.npy"

sample:
  prior:
    n: 1000
    path: samples_prior.joblib
  proposal:
    n: 1000
    path: samples_proposal.joblib
  posterior:
    n: 10000
    path: samples_posterior.joblib
